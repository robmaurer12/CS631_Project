{% extends "layout.html" %}
{% block content %}

<h2>Project Manager</h2>
<div class="row">

    <div class="col-md-8">
        <div style="max-height: 500px; overflow-y: auto; border: 1px solid #ddd; padding: 5px;">
            <table id="projectTable" class="table table-striped">
                <thead>
                    <tr>
                        <th>Project #</th>
                        <th>Name</th>
                        <th>Manager</th>
                        <th>Budget</th>
                        <th>Start</th>
                        <th>End</th>
                        <th>Team</th>
                        <th>Hours Worked</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in projects %}
                    <tr class="project-row"
                        data-project-id="{{ p.project_number }}"
                        data-project-name="{{ p.name }}"
                        data-project-desc="{{ p.description }}"
                        data-project-budget="{{ p.budget }}"
                        data-project-manager-id="{{ p.manager_id }}"
                        data-project-start="{{ p.start_date.strftime('%Y-%m-%d') if p.start_date else '' }}"
                        data-project-end="{{ p.end_date.strftime('%Y-%m-%d') if p.end_date else '' }}"
                        data-project-team-ids="{% for t in p.team %}{{ t.employee.employee_no }}{% if not loop.last %},{% endif %}{% endfor %}"
                        data-project-team-names="{% for t in p.team %}{{ t.employee.employee_name }}{% if not loop.last %}, {% endif %}{% endfor %}"
                        data-project-worklogs='{{ p.worklogs_json | tojson }}'
                        data-project-milestones='{{ p.milestones_json | tojson }}'
                    >
                        <td>{{ p.project_number }}</td>
                        <td>{{ p.name }}</td>
                        <td>{{ p.manager.employee_name if p.manager else "" }}</td>
                        <td>${{ "%.2f"|format(p.budget) if p.budget else "" }}</td>
                        <td>{{ p.start_date.strftime('%Y-%m-%d') if p.start_date else '' }}</td>
                        <td>{{ p.end_date.strftime('%Y-%m-%d') if p.end_date else '' }}</td>
                        <td>
                            {% for t in p.team %}
                                <span class="badge bg-secondary">{{ t.employee.employee_name }}</span>
                            {% else %}
                                <span class="text-muted">No team</span>
                            {% endfor %}
                        </td>
                        <td class="project-total-hours">{{ p.worklogs | sum(attribute='hours_worked') }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    
    <div class="col-md-4">
        <h3>Project Details</h3>
        <table id="projectDetails" class="table table-bordered">
            <tbody>
                <tr>
                    <th>Project ID</th>
                    <td><input id="detail-project-id" type="number" class="form-control" readonly></td>
                </tr>
                <tr>
                    <th>Name</th>
                    <td><input id="detail-project-name" class="form-control"></td>
                </tr>
                <tr>
                    <th>Description</th>
                    <td><textarea id="detail-project-desc" class="form-control"></textarea></td>
                </tr>
                <tr>
                    <th>Manager ID</th>
                    <td><input id="detail-project-manager-id" type="number" class="form-control"></td>
                </tr>
                <tr>
                    <th>Budget</th>
                    <td><input id="detail-project-budget" type="number" step="0.01" class="form-control"></td>
                </tr>
                <tr>
                    <th>Start</th>
                    <td><input id="detail-project-start" type="date" class="form-control"></td>
                </tr>
                <tr>
                    <th>End</th>
                    <td><input id="detail-project-end" type="date" class="form-control"></td>
                </tr>
                <tr>
                    <th>Team</th>
                    <td><input id="detail-project-team" class="form-control" readonly placeholder="Select project to view team"></td>
                </tr>
                <tr>
                    <th>Worklogs</th>
                    <td>
                        <table id="worklog-table" class="table table-sm table-bordered mb-2">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Employee</th>
                                    <th>Hours</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="worklog-tbody">
                               
                            </tbody>
                        </table>
                        <div class="d-flex gap-2 mt-1">
                            <input id="new-worklog-employee" class="form-control" placeholder="Employee Name" style="width:150px;">
                            <input id="new-worklog-hours" class="form-control" type="number" placeholder="Hours" style="width:80px;">
                            <button id="btn-add-worklog" class="btn btn-sm btn-success">Add</button>
                        </div>
                        <div class="mt-1">Total Hours: <span id="total-hours">0</span></div>
                    </td>
                </tr>
            </tbody>
        </table>

        <div class="d-flex gap-2 mt-2">
            <button id="btn-update-project" class="btn btn-primary flex-grow-1">Save</button>
            <button id="btn-delete-project" class="btn btn-danger flex-grow-1">Delete</button>
            <button id="btn-new-project" class="btn btn-secondary flex-grow-1">New</button>
            <button id="btn-view-milestones" class="btn btn-secondary flex-grow-1">Show Milestones</button>
        </div>

        <div id="project-msg" class="mt-2"></div>
    </div>
</div>


<div id="milestoneModal" class="modal-overlay" style="display:none;">
    <div class="modal-content" style="max-width:800px;">
        <span id="milestoneModalCloseBtn" class="close">&times;</span>
        <h3 class="mb-3">Project Milestones</h3>
        <h5 id="milestoneProjectTitle" class="text-muted"></h5>
        <div style="max-height: 400px; overflow-y: auto;">
            <table class="table table-bordered mt-3">
                <thead class="table-light">
                    <tr>
                        <th>Title</th>
                        <th>Description</th>
                        <th>Status</th>
                        <th>Due Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="milestoneTableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='scripts/project_manager.js') }}"></script>
{% endblock %}
