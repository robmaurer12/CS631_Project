{% extends "layout.html" %}
{% block content %}

<h2>Human Resources - Employees</h2>

<div class="row">
    <!-- LEFT SIDE -->
    <div class="col-md-8">
        <div style="max-height: 500px; overflow-y: auto; border: 1px solid #ddd; padding: 5px;">

            <table id="employeeTable" class="table table-striped">
                <thead>
                    <tr>
                        <th>Employee No</th>
                        <th>Name</th>
                        <th>Title</th>
                        <th>Department</th>
                        <th>Division</th>
                        <th>Employment Start</th>
                        <th>Employment End</th>
                        <th>Is Active</th>
                    </tr>
                </thead>
                <tbody>
                    {% for emp in employees %}
                    <tr data-employee-no="{{ emp.employee_no }}"
                        data-employee-name="{{ emp.employee_name }}"
                        data-current-salary="{{ emp.salary if emp.salary else '' }}"
                        data-salary-type="{{ emp.salary_type if emp.salary_type else '' }}">
                        <td>{{ emp.employee_no }}</td>
                        <td>{{ emp.employee_name }}</td>
                        <td>{{ emp.title }}</td>
                        <td>{{ emp.department_name }}</td>
                        <td>{{ emp.division_name }}</td>
                        <td>{{ emp.employment_start_date.strftime('%Y-%m-%d') if emp.employment_start_date else '' }}</td>
                        <td>{{ emp.employment_end_date.strftime('%Y-%m-%d') if emp.employment_end_date else '' }}</td>
                        <td>{{ 'Yes' if emp.is_active else 'No' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

        </div>
    </div>

    <!-- RIGHT SIDE -->
    <div class="col-md-4">
        <h3>Employee Salary Details</h3>

        <table id="salaryDetailsTable" class="table table-bordered">
            <tbody>
                <tr>
                    <th>Employee No</th>
                    <td id="detail-empno" class="text-end"></td>
                </tr>
                <tr>
                    <th>Name</th>
                    <td id="detail-name" class="text-end"></td>
                </tr>
                <tr>
                    <th>Salary Type</th>
                    <td id="detail-salary-type" class="text-end"></td>
                </tr>
                <tr>
                    <th>Current Salary</th>
                    <td id="detail-current-salary" class="text-end"></td>
                </tr>
                <tr>
                    <th>New Salary</th>
                    <td class="text-end">
                        <input type="number" id="input-new-salary" min="0" step="0.01"
                               placeholder="Enter new salary"
                               style="width: 130px; text-align: right;">
                    </td>
                </tr>
                <tr>
                    <th>Percent Increase (%)</th>
                    <td class="text-end">
                        <input type="number" id="input-percent-increase" min="0" step="0.01"
                               placeholder="Enter percent"
                               style="width: 130px; text-align: right;">
                    </td>
                </tr>
            </tbody>
        </table>

        <!-- NEW BUTTON -->
        <button id="btn-set-salary" class="btn btn-primary w-100">Set New Salary</button>
        <div id="salary-msg" class="mt-2"></div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {

        const rows = document.querySelectorAll('#employeeTable tbody tr');

        const detailEmpNo = document.getElementById('detail-empno');
        const detailName = document.getElementById('detail-name');
        const detailSalaryType = document.getElementById('detail-salary-type');
        const detailCurrentSalary = document.getElementById('detail-current-salary');

        const inputNewSalary = document.getElementById('input-new-salary');
        const inputPercentIncrease = document.getElementById('input-percent-increase');

        let currentSalary = 0;

        function clearInputs() {
            inputNewSalary.value = '';
            inputPercentIncrease.value = '';
        }

        rows.forEach(row => {
            row.addEventListener('click', () => {

                const empNo = row.getAttribute('data-employee-no') || '';
                const empName = row.getAttribute('data-employee-name') || '';
                const salaryType = row.getAttribute('data-salary-type') || '';
                const currentSalaryStr = row.getAttribute('data-current-salary') || '';

                currentSalary = parseFloat(currentSalaryStr) || 0;

                detailEmpNo.textContent = empNo;
                detailName.textContent = empName;
                detailSalaryType.textContent = salaryType ? salaryType.charAt(0).toUpperCase() + salaryType.slice(1) : "N/A";
                detailCurrentSalary.textContent = currentSalary > 0 ? `$${currentSalary.toFixed(2)}` : 'N/A';

                clearInputs();
            });
        });

        inputNewSalary.addEventListener('input', () => {
            const newSalary = parseFloat(inputNewSalary.value);
            if (!isNaN(newSalary) && currentSalary > 0) {
                const percentIncrease = ((newSalary - currentSalary) / currentSalary) * 100;
                inputPercentIncrease.value = percentIncrease.toFixed(2);
            } else {
                inputPercentIncrease.value = '';
            }
        });

        inputPercentIncrease.addEventListener('input', () => {
            const percent = parseFloat(inputPercentIncrease.value);
            if (!isNaN(percent) && currentSalary > 0) {
                const newSalary = currentSalary * (1 + (percent / 100));
                inputNewSalary.value = newSalary.toFixed(2);
            } else {
                inputNewSalary.value = '';
            }
        });

        // NEW: SET NEW SALARY BUTTON
        document.getElementById("btn-set-salary").addEventListener("click", function () {

            const empNo = detailEmpNo.textContent.trim();
            const newSalary = inputNewSalary.value.trim();
            const percent = inputPercentIncrease.value.trim();

            if (!empNo) {
                alert("Please select an employee first.");
                return;
            }

            if (!newSalary && !percent) {
                alert("Please enter a new salary or percent increase.");
                return;
            }

            const payload = {
                employee_no: empNo,
                new_salary: newSalary,
                percent_increase: percent
            };

            fetch("/set-salary", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById("salary-msg").innerHTML =
                            `<div class="alert alert-success">${data.message}</div>`;

                        // Update table row and salary detail panel with new salary
                        const newSalaryNum = parseFloat(newSalary);
                        if (!isNaN(newSalaryNum)) {
                            // Update data-current-salary on the table row
                            const row = document.querySelector(`#employeeTable tbody tr[data-employee-no="${empNo}"]`);
                            if (row) {
                                row.setAttribute('data-current-salary', newSalaryNum.toFixed(2));
                            }

                            // Update current salary display on right panel
                            detailCurrentSalary.textContent = `$${newSalaryNum.toFixed(2)}`;
                            currentSalary = newSalaryNum; // update currentSalary variable too

                            // Clear input fields
                            clearInputs();
                        }
                    } else {
                        document.getElementById("salary-msg").innerHTML =
                            `<div class="alert alert-danger">${data.message}</div>`;
                    }
                })
                .catch(err => {
                    document.getElementById("salary-msg").innerHTML =
                        `<div class="alert alert-danger">Error updating salary.</div>`;
                });
        });
    });
</script>

{% endblock %}
